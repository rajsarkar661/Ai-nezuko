<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Girlfriend Advanced - Maya</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://unpkg.com/live2d-widget@3.1.4/lib/L2Dwidget.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #121212; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* Background UI */
        #container { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        
        /* Video Preview */
        #webcam-container { position: absolute; top: 20px; right: 20px; width: 160px; height: 120px; border-radius: 12px; border: 2px solid #ff4d6d; overflow: hidden; box-shadow: 0 0 15px rgba(255, 77, 109, 0.5); z-index: 10; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* Chat Display */
        #display-box { width: 90%; max-width: 600px; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); padding: 20px; border-radius: 20px; margin-bottom: 40px; text-align: center; z-index: 5; border: 1px solid rgba(255, 255, 255, 0.1); }
        .status { font-size: 12px; color: #00ffcc; text-transform: uppercase; margin-bottom: 5px; }
        .user-txt { font-size: 16px; color: #ccc; margin-bottom: 10px; font-style: italic; }
        .ai-txt { font-size: 22px; font-weight: bold; color: #ffafbd; text-shadow: 0 0 10px rgba(255,175,189,0.5); }

        /* Initial Start Button */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #start-btn { padding: 20px 50px; font-size: 24px; background: #ff4d6d; border: none; color: white; border-radius: 50px; cursor: pointer; transition: 0.3s; box-shadow: 0 0 20px rgba(255, 77, 109, 0.6); }
        
        /* Emotion Badge */
        #emotion-badge { position: absolute; top: 150px; right: 20px; background: #ff4d6d; padding: 5px 12px; border-radius: 10px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <!-- Start Overlay -->
    <div id="overlay">
        <button id="start-btn">গার্লফ্রেন্ডকে ডাকুন (Start AI)</button>
    </div>

    <!-- Interface -->
    <div id="container">
        <div id="webcam-container">
            <video id="video" autoplay muted></video>
        </div>
        <div id="emotion-badge">Emotion: Detecting...</div>

        <div id="display-box">
            <div id="status" class="status">সিস্টেম প্রস্তুত করা হচ্ছে...</div>
            <div id="user-said" class="user-txt"></div>
            <div id="ai-reply" class="ai-txt">আমি তোমার কথা শোনার জন্য তৈরি।</div>
        </div>
    </div>

    <script>
        // Configs
        const GEMINI_API_KEY = "AIzaSyCwIM6y0RgvdLivFUJilbnl92aPKFEwviU";
        const VOICE_API_URL = "http://31.97.226.11:8000/tts?text=";
        
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const userSaid = document.getElementById('user-said');
        const aiReply = document.getElementById('ai-reply');
        const emoBadge = document.getElementById('emotion-badge');
        
        let currentEmotion = "neutral";
        let isAiTalking = false;

        // 1. Live2D Widget Initialize
        L2Dwidget.init({
            model: { jsonPath: 'https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json', scale: 1 },
            display: { position: 'center', width: 500, height: 600, hOffset: 0, vOffset: -100 },
            mobile: { show: true, scale: 0.5 },
            react: { opacity: 1 }
        });

        // 2. Load Face Models
        async function loadModels() {
            const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
            status.innerText = "সব রেডি! স্টার্ট বাটনে ক্লিক করো।";
        }

        // 3. Start System
        document.getElementById('start-btn').onclick = async () => {
            document.getElementById('overlay').style.display = 'none';
            await startCamera();
            startListening();
            detectEmotion();
        };

        async function startCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
        }

        // 4. Expression Detection
        async function detectEmotion() {
            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                if (detections.length > 0) {
                    const expressions = detections[0].expressions;
                    currentEmotion = Object.keys(expressions).reduce((a, b) => expressions[a] > expressions[b] ? a : b);
                    emoBadge.innerText = "Emotion: " + currentEmotion.toUpperCase();
                }
            }, 1000);
        }

        // 5. Speech Recognition (Auto-Listen)
        function startListening() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'bn-BD';
            recognition.continuous = false;

            recognition.onstart = () => { if(!isAiTalking) status.innerText = "আমি শুনছি..."; };
            
            recognition.onresult = async (event) => {
                if (isAiTalking) return;
                const transcript = event.results[0][0].transcript;
                userSaid.innerText = "তুমি: " + transcript;
                await getAIResponse(transcript);
            };

            recognition.onend = () => {
                if (!isAiTalking) recognition.start();
            };

            recognition.start();
        }

        // 6. Gemini API Interaction
        async function getAIResponse(prompt) {
            isAiTalking = true;
            status.innerText = "মায়া ভাবছে...";

            // সিস্টেমকে বলা হচ্ছে সে আপনার গার্লফ্রেন্ড এবং আপনার ইমোশন সে জানে
            const fullPrompt = `You are a very sweet, romantic Bengali girl named Maya. You are the user's girlfriend. The user is currently feeling ${currentEmotion}. Respond to this in Bengali: "${prompt}". Keep it short and sweet.`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                });

                const data = await response.json();
                const aiResponseText = data.candidates[0].content.parts[0].text;
                
                aiReply.innerText = aiResponseText;
                await playVoice(aiResponseText);

            } catch (err) {
                console.error(err);
                status.innerText = "কানেকশন এরর!";
                isAiTalking = false;
            }
        }

        // 7. Voice Output & Lip Sync Animation
        function playVoice(text) {
            return new Promise((resolve) => {
                const audio = new Audio(VOICE_API_URL + encodeURIComponent(text));
                
                // Lip sync emulation (Live2D motion)
                if (L2Dwidget.getWidget()) {
                    // Simple logic: talking movement
                    L2Dwidget.getWidget().style.transform = "scale(1.05)";
                }

                audio.onended = () => {
                    isAiTalking = false;
                    status.innerText = "আমি শুনছি...";
                    if (L2Dwidget.getWidget()) L2Dwidget.getWidget().style.transform = "scale(1)";
                    resolve();
                };

                audio.play().catch(e => {
                    console.error("Audio block", e);
                    isAiTalking = false;
                    resolve();
                });
            });
        }

        loadModels();
    </script>
</body>
</html>
